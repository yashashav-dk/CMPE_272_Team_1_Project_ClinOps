generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String?
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Project {
  id            String        @id
  userId        String        @map("user_id")
  name          String
  description   String?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  chatHistories ChatHistory[]

  @@index([userId])
  @@map("projects")
}

model ChatHistory {
  id             String                 @id
  projectId      String                 @map("project_id")
  userId         String                 @map("user_id")
  persona        String?
  currentTab     String?                @map("current_tab")
  projectInfo    Json?                  @map("project_info")
  createdAt      DateTime               @default(now()) @map("created_at")
  updatedAt      DateTime               @updatedAt @map("updated_at")
  project        Project                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages       Message[]
  tabContents    TabContent[]
  tabGenerations TabContentGeneration[]

  @@index([projectId], map: "idx_chat_history_project_id")
  @@map("chat_history")
}

model Message {
  id        String      @id
  chatId    String      @map("chat_id")
  text      String
  sender    String
  persona   String?
  timestamp DateTime    @default(now())
  chat      ChatHistory @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId], map: "idx_messages_chat_id")
  @@map("messages")
}

model TabContent {
  id          String      @id
  chatId      String      @map("chat_id")
  tabType     String      @map("tab_type")
  content     String
  generatedAt DateTime    @default(now()) @map("generated_at")
  chat        ChatHistory @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId], map: "idx_tab_content_chat_id")
  @@map("tab_content")
}

model TabContentGeneration {
  id        String      @id
  chatId    String      @map("chat_id")
  tabType   String      @map("tab_type")
  status    String
  updatedAt DateTime    @updatedAt @map("updated_at")
  chat      ChatHistory @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@map("tab_content_generation")
}

model AiResponse {
  id         String   @id
  projectId  String   @map("project_id")
  tabType    String   @map("tab_type")
  promptHash String   @map("prompt_hash")
  prompt     String
  response   String
  userId     String   @map("user_id")
  persona    String?
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([projectId, tabType, promptHash], map: "idx_ai_responses_project_tab_hash")
  @@map("ai_responses")
}

model AiResponseCache {
  promptHash String   @id @map("prompt_hash")
  prompt     String
  response   String
  userId     String   @map("user_id")
  projectId  String?  @map("project_id")
  persona    String?
  tabType    String?  @map("tab_type")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("ai_response_cache")
}

model SavedDiagram {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  userId      String   @map("user_id")
  title       String
  description String?
  diagramCode String   @map("diagram_code")
  diagramType String?  @map("diagram_type")
  context     Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([projectId], map: "idx_saved_diagrams_project_id")
  @@index([userId], map: "idx_saved_diagrams_user_id")
  @@map("saved_diagrams")
}

model DashboardWidget {
  id         String   @id @default(uuid())
  projectId  String   @map("project_id")
  userId     String   @map("user_id")
  tabType    String   @map("tab_type")
  widgetType String   @map("widget_type")
  title      String
  content    Json
  rawContent String   @map("raw_content")
  order      Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([projectId], map: "idx_dashboard_widgets_project_id")
  @@index([userId], map: "idx_dashboard_widgets_user_id")
  @@map("dashboard_widgets")
}

model Feedback {
  id        String   @id @default(uuid())
  projectId String?  @map("project_id")
  userId    String?  @map("user_id")
  persona   String?
  tabType   String?  @map("tab_type")
  message   String
  createdAt DateTime @default(now()) @map("created_at")

  @@index([projectId], map: "idx_feedback_project_id")
}

model DashboardReview {
  id        String   @id @default(uuid())
  projectId String   @map("project_id")
  authorId  String   @map("author_id")
  text      String
  rating    Int?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([projectId], map: "idx_dashboard_reviews_project_id")
  @@map("dashboard_reviews")
}
